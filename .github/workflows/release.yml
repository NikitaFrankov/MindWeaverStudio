name: Release (unsigned DMG)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version, for example v1.2.0"
        required: true
      changelog:
        description: "Release description"
        required: true
        default: ""

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
      - uses: gradle/actions/setup-gradle@v3
      - name: Build DMG
        run: ./gradlew --no-daemon clean packageDmg
      - name: Locate DMG
        id: find_art
        shell: bash
        run: |
          ART=$(ls -1 build/compose/**/dmg/*.dmg 2>/dev/null | head -n1 || true)
          if [[ -z "$ART" ]]; then
            ART=$(find . -type f -name "*.dmg" | head -n1 || true)
          fi
          if [[ -z "$ART" ]]; then
            echo "❌ DMG not found"
            exit 1
          fi
          echo "artifact=$ART" >> "$GITHUB_OUTPUT"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mac-dmg
          path: ${{ steps.find_art.outputs.artifact }}

  release:
    needs: [build-mac]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: mac-dmg
          path: dist
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: ${{ github.event.inputs.changelog }}
          files: dist/*.dmg
